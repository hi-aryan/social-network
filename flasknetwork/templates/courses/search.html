{% extends "layout.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="content-section">
            <div class="text-center mb-4">
                <h2 class="article-title mb-2">Search or Browse Courses</h2>
            </div>
            <!-- Search Form -->
            <div class="mb-5">
                <input type="text" 
                       class="form-control form-control-lg" 
                       id="courseSearchInput" 
                       placeholder="search by course name or code"
                       autocomplete="off">
            </div>
            
            <!-- Loading Indicator -->
            <div id="loadingIndicator" class="text-center d-none">
                <div class="spinner-border text-theme-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-theme-primary">Searching courses...</p>
            </div>
            
            <!-- Error Message -->
            <div id="errorMessage" class="alert alert-danger d-none" role="alert">
                <strong>Error:</strong> <span id="errorText"></span>
            </div>
            
            <!-- Search Results -->
            <div id="searchResults">
                <div id="noResults" class="text-center text-theme-primary d-none">
                    <i class="fas fa-search fa-3x mb-3"></i>
                    <h5>No courses found</h5>
                    <p>Try adjusting your search terms</p>
                </div>
                
                <div id="resultsContainer" class="d-none">
                    <div class="mb-3 border-bottom pb-2">
                        <small class="text-theme-primary" id="searchQuery"></small>
                    </div>
                    <div id="coursesList"></div>
                    
                    <!-- Load More Button -->
                    <div id="loadMoreContainer" class="text-center py-3 d-none">
                        <button id="loadMoreBtn" class="btn btn-primary">
                            Load More
                        </button>
                    </div>
                    
                    <!-- Bottom loading spinner -->
                    <div id="loadingMore" class="text-center py-3 d-none">
                        <div class="spinner-border spinner-border-sm text-theme-primary" role="status">
                            <span class="visually-hidden">Loading more...</span>
                        </div>
                    </div>
                    
                    <!-- End of results message -->
                    <div id="endOfResults" class="text-center text-theme-primary py-3 d-none">
                        <small>All courses loaded</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Course Item Template (Hidden) -->
<template id="courseItemTemplate">
    <a href="#" class="course-item d-block text-decoration-none mb-3">
        <div class="card-body p-3 course-card-hover position-relative">
            <div class="row align-items-center">
                <div class="col">
                    <h5 class="card-title mb-1 text-dark">
                        <span class="course-code fw-bold"></span> - 
                        <span class="course-name"></span>
                    </h5>
                    <p class="card-text mb-0">
                        <small class="text-theme-primary">
                            <i class="fas fa-star me-1"></i>
                            <span class="review-count"></span>
                        </small>
                    </p>
                </div>
            </div>
            <span class="d-md-none">></span>
        </div>
    </a>
</template>
{% endblock content %}

{% block scripts %}
<script>
class CourseSearch {
    constructor() {
        this.searchInput = document.getElementById('courseSearchInput');
        this.loadingIndicator = document.getElementById('loadingIndicator');
        this.errorMessage = document.getElementById('errorMessage');
        this.errorText = document.getElementById('errorText');
        this.noResults = document.getElementById('noResults');
        this.resultsContainer = document.getElementById('resultsContainer');
        this.coursesList = document.getElementById('coursesList');
        this.searchQuery = document.getElementById('searchQuery');
        this.courseTemplate = document.getElementById('courseItemTemplate');
        this.loadMoreContainer = document.getElementById('loadMoreContainer');
        this.loadMoreBtn = document.getElementById('loadMoreBtn');
        this.loadingMore = document.getElementById('loadingMore');
        this.endOfResults = document.getElementById('endOfResults');
        
        this.searchTimeout = null;
        this.currentRequest = null;
        
        // Pagination state
        this.mode = 'browse'; // 'browse' or 'search'
        this.offset = 0;
        this.limit = 20;
        this.hasMore = true;
        this.isLoading = false;
        
        this.init();
    }
    
    init() {
        // Event listeners
        this.searchInput.addEventListener('input', (e) => {
            this.handleSearchInput(e.target.value);
        });
        
        // Load More button click handler
        this.loadMoreBtn.addEventListener('click', () => {
            this.loadCourses();
        });
        
        // Check URL params
        const urlParams = new URLSearchParams(window.location.search);
        const query = urlParams.get('q');
        if (query) {
            this.searchInput.value = query;
            this.handleSearchInput(query);
        } else {
            // Load all courses by default (browse mode)
            this.loadCourses();
        }
        
        // Always focus and select the input for easy editing
        this.searchInput.focus();
        this.searchInput.select();
    }
    
    handleSearchInput(query) {
        // Cancel previous timeout
        if (this.searchTimeout) {
            clearTimeout(this.searchTimeout);
        }
        
        // Cancel previous request
        if (this.currentRequest) {
            this.currentRequest.abort();
        }
        
        // Trim query
        query = query.trim();
        
        if (query.length === 0) {
            // Switch back to browse mode
            this.resetState();
            this.mode = 'browse';
            this.loadCourses();
            return;
        }
        
        if (query.length < 2) {
            return;
        }
        
        // Switch to search mode
        this.mode = 'search';
        
        // Debounce search
        this.searchTimeout = setTimeout(() => {
            this.performSearch(query);
        }, 300);
    }
    
    resetState() {
        this.offset = 0;
        this.hasMore = true;
        this.coursesList.innerHTML = '';
        this.hideAllStates();
    }
    
    async loadCourses() {
        if (this.isLoading || !this.hasMore) return;
        
        this.isLoading = true;
        
        try {
            // Show initial loading or bottom loading
            if (this.offset === 0) {
                this.showLoading();
            } else {
                this.loadMoreContainer.classList.add('d-none');
                this.loadingMore.classList.remove('d-none');
            }
            
            // Disable button while loading
            this.loadMoreBtn.disabled = true;
            
            // Create AbortController for request cancellation
            const controller = new AbortController();
            this.currentRequest = controller;
            
            const response = await fetch(`/courses/api/search?limit=${this.limit}&offset=${this.offset}`, {
                signal: controller.signal
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `HTTP ${response.status}`);
            }
            
            const data = await response.json();
            this.appendCourses(data.courses, data.has_more);
            
        } catch (error) {
            if (error.name === 'AbortError') {
                return;
            }
            console.error('Load error:', error);
            this.showError(error.message || 'Failed to load courses');
        } finally {
            this.isLoading = false;
            this.currentRequest = null;
            this.loadingMore.classList.add('d-none');
            this.loadMoreBtn.disabled = false;
        }
    }
    
    appendCourses(courses, hasMore) {
        this.loadingIndicator.classList.add('d-none');
        
        if (courses.length === 0 && this.offset === 0) {
            this.noResults.classList.remove('d-none');
            return;
        }
        
        // Append course items
        courses.forEach(course => {
            const courseElement = this.createCourseElement(course);
            this.coursesList.appendChild(courseElement);
        });
        
        // Update state
        this.offset += courses.length;
        this.hasMore = hasMore;
        
        // Update header
        this.searchQuery.textContent = 'Browse all courses';
        
        // Show results container
        this.resultsContainer.classList.remove('d-none');
        
        // Show/hide Load More button and end of results message
        if (!hasMore) {
            this.loadMoreContainer.classList.add('d-none');
            this.endOfResults.classList.remove('d-none');
        } else {
            this.loadMoreContainer.classList.remove('d-none');
            this.endOfResults.classList.add('d-none');
        }
    }
    
    async performSearch(query) {
        try {
            this.resetState();
            this.showLoading();
            
            // Create AbortController for request cancellation
            const controller = new AbortController();
            this.currentRequest = controller;
            
            const response = await fetch(`/courses/api/search?q=${encodeURIComponent(query)}&limit=50`, {
                signal: controller.signal
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `HTTP ${response.status}`);
            }
            
            const data = await response.json();
            this.displaySearchResults(data.courses, query);
            
        } catch (error) {
            if (error.name === 'AbortError') {
                return;
            }
            console.error('Search error:', error);
            this.showError(error.message || 'Failed to search courses');
        } finally {
            this.currentRequest = null;
        }
    }
    
    displaySearchResults(courses, query) {
        this.hideAllStates();
        
        if (courses.length === 0) {
            this.noResults.classList.remove('d-none');
            return;
        }
        
        // Clear previous results
        this.coursesList.innerHTML = '';
        
        // Update header
        this.searchQuery.textContent = `Results for "${query}"`;
        
        // Create course items
        courses.forEach(course => {
            const courseElement = this.createCourseElement(course);
            this.coursesList.appendChild(courseElement);
        });
        
        // No pagination for search results (they're all loaded at once)
        this.hasMore = false;
        this.loadMoreContainer.classList.add('d-none');
        this.endOfResults.classList.add('d-none');
        
        this.resultsContainer.classList.remove('d-none');
    }
    
    createCourseElement(course) {
        const template = this.courseTemplate.content.cloneNode(true);

        // Set course data
        template.querySelector('.course-code').textContent = course.code;
        template.querySelector('.course-name').textContent = course.name;

        // Set review count
        const reviewText = course.review_count === 0 ? 'No reviews yet' : 
                          course.review_count === 1 ? '1 review' : 
                          `${course.review_count} reviews`;
        template.querySelector('.review-count').textContent = reviewText;

        // Set root href so whole card links to course detail
        const courseUrl = `/courses/course/${course.id}`;
        const root = template.querySelector('.course-item');
        if (root) root.href = courseUrl;

        return template;
    }
    
    showLoading() {
        this.hideAllStates();
        this.loadingIndicator.classList.remove('d-none');
    }
    
    showError(message) {
        this.hideAllStates();
        this.errorText.textContent = message;
        this.errorMessage.classList.remove('d-none');
    }
    
    hideAllStates() {
        this.loadingIndicator.classList.add('d-none');
        this.errorMessage.classList.add('d-none');
        this.noResults.classList.add('d-none');
        this.resultsContainer.classList.add('d-none');
        this.loadMoreContainer.classList.add('d-none');
        this.endOfResults.classList.add('d-none');
    }
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    new CourseSearch();
});
</script>
{% endblock scripts %}