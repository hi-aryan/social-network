{% extends "layout.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="content-section">
            <div class="text-center mb-4">
                <h2 class="article-title mb-2">Search Courses</h2>
                <p class="text-theme-primary">Read reviews from fellow students</p>
            </div>
            <!-- Search Form -->
            <div class="mb-4">
                <input type="text" 
                       class="form-control form-control-lg" 
                       id="courseSearchInput" 
                       placeholder="Search by course name or code"
                       autocomplete="off">
                <div class="form-text mt-2">
                    <small class="text-theme-primary">Enter at least 2 characters to search</small>
                </div>
            </div>
            
            <!-- Loading Indicator -->
            <div id="loadingIndicator" class="text-center d-none">
                <div class="spinner-border text-theme-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-theme-primary">Searching courses...</p>
            </div>
            
            <!-- Error Message -->
            <div id="errorMessage" class="alert alert-danger d-none" role="alert">
                <strong>Error:</strong> <span id="errorText"></span>
            </div>
            
            <!-- Search Results -->
            <div id="searchResults">
                <div id="noResults" class="text-center text-theme-primary d-none">
                    <i class="fas fa-search fa-3x mb-3"></i>
                    <h5>No courses found</h5>
                    <p>Try adjusting your search terms</p>
                </div>
                
                <div id="resultsContainer" class="d-none">
                    <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                        <h5 id="resultsCount" class="mb-0"></h5>
                        <small class="text-theme-primary" id="searchQuery"></small>
                    </div>
                    <div id="coursesList"></div>
                </div>
            </div>
            
            <div id="initialHelp" class="text-center text-theme-primary">
            </div>
        </div>
    </div>
</div>

<!-- Course Item Template (Hidden) -->
<template id="courseItemTemplate">
    <a href="#" class="course-item d-block text-decoration-none mb-3">
        <div class="card-body p-3 course-card-hover">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h5 class="card-title mb-1 text-dark">
                        <span class="course-code fw-bold"></span> - 
                        <span class="course-name"></span>
                    </h5>
                    <p class="card-text mb-0">
                        <small class="text-theme-primary">
                            <i class="fas fa-star me-1"></i>
                            <span class="review-count"></span>
                        </small>
                    </p>
                </div>
                <div class="col-md-4 text-md-end">
                    <span class="btn btn-sm btn-primary mt-2 mt-md-0">
                        View Reviews
                    </span>
                </div>
            </div>
        </div>
    </a>
</template>
{% endblock content %}

{% block scripts %}
<script>
class CourseSearch {
    constructor() {
        this.searchInput = document.getElementById('courseSearchInput');
        this.loadingIndicator = document.getElementById('loadingIndicator');
        this.errorMessage = document.getElementById('errorMessage');
        this.errorText = document.getElementById('errorText');
        this.noResults = document.getElementById('noResults');
        this.resultsContainer = document.getElementById('resultsContainer');
        this.coursesList = document.getElementById('coursesList');
        this.resultsCount = document.getElementById('resultsCount');
        this.searchQuery = document.getElementById('searchQuery');
        this.initialHelp = document.getElementById('initialHelp');
        this.courseTemplate = document.getElementById('courseItemTemplate');
        
        this.searchTimeout = null;
        this.currentRequest = null;
        
        this.init();
    }
    
    init() {
        // Event listeners
        this.searchInput.addEventListener('input', (e) => {
            this.handleSearchInput(e.target.value);
        });
        
        // Check URL params
        const urlParams = new URLSearchParams(window.location.search);
        const query = urlParams.get('q');
        if (query) {
            this.searchInput.value = query;
            this.handleSearchInput(query);
        }
        // Always focus and select the input for easy editing
        this.searchInput.focus();
        this.searchInput.select();
    }
    
    handleSearchInput(query) {
        // Cancel previous timeout
        if (this.searchTimeout) {
            clearTimeout(this.searchTimeout);
        }
        
        // Cancel previous request
        if (this.currentRequest) {
            this.currentRequest.abort();
        }
        
        // Clear previous results and errors
        this.hideAllStates();
        
        // Trim query
        query = query.trim();
        
        if (query.length === 0) {
            this.showInitialState();
            return;
        }
        
        if (query.length < 2) {
            // this.showError('Please enter at least 2 characters');
            return;
        }
        
        // Debounce search
        this.searchTimeout = setTimeout(() => {
            this.performSearch(query);
        }, 300);
    }
    
    async performSearch(query) {
        try {
            this.showLoading();
            
            // Create AbortController for request cancellation
            const controller = new AbortController();
            this.currentRequest = controller;
            
            const response = await fetch(`/courses/api/search?q=${encodeURIComponent(query)}&limit=50`, {
                signal: controller.signal
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `HTTP ${response.status}`);
            }
            
            const courses = await response.json();
            this.displayResults(courses, query);
            
        } catch (error) {
            if (error.name === 'AbortError') {
                // Request was cancelled, ignore
                return;
            }
            
            console.error('Search error:', error);
            this.showError(error.message || 'Failed to search courses');
        } finally {
            this.currentRequest = null;
        }
    }
    
    displayResults(courses, query) {
        this.hideAllStates();
        
        if (courses.length === 0) {
            this.noResults.classList.remove('d-none');
            return;
        }
        
        // Clear previous results
        this.coursesList.innerHTML = '';
        
        // Update results info
        this.resultsCount.textContent = `${courses.length} course${courses.length !== 1 ? 's' : ''} found`;
        this.searchQuery.textContent = `for "${query}"`;
        
        // Create course items
        courses.forEach(course => {
            const courseElement = this.createCourseElement(course);
            this.coursesList.appendChild(courseElement);
        });
        
        this.resultsContainer.classList.remove('d-none');
    }
    
    createCourseElement(course) {
        const template = this.courseTemplate.content.cloneNode(true);

        // Set course data
        template.querySelector('.course-code').textContent = course.code;
        template.querySelector('.course-name').textContent = course.name;

        // Set review count
        const reviewText = course.review_count === 0 ? 'No reviews yet' : 
                          course.review_count === 1 ? '1 review' : 
                          `${course.review_count} reviews`;
        template.querySelector('.review-count').textContent = reviewText;

        // Set root href so whole card links to course detail
        const courseUrl = `/courses/course/${course.id}`;
        const root = template.querySelector('.course-item');
        if (root) root.href = courseUrl;

        return template;
    }
    
    showLoading() {
        this.hideAllStates();
        this.loadingIndicator.classList.remove('d-none');
    }
    
    showError(message) {
        this.hideAllStates();
        this.errorText.textContent = message;
        this.errorMessage.classList.remove('d-none');
    }
    
    showInitialState() {
        this.hideAllStates();
        this.initialHelp.classList.remove('d-none');
    }
    
    hideAllStates() {
        this.loadingIndicator.classList.add('d-none');
        this.errorMessage.classList.add('d-none');
        this.noResults.classList.add('d-none');
        this.resultsContainer.classList.add('d-none');
        this.initialHelp.classList.add('d-none');
    }
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    new CourseSearch();
});
</script>
{% endblock scripts %}