{% extends "layout.html" %}
{% block content %}
    <div class="content-section">
        <form method="POST" action="" autocomplete="off">
            {{ form.hidden_tag() }}
            <fieldset class="mb-3">
                <legend class="border-bottom mb-4 pb-2">{{ legend }}</legend>

                <!-- Course Selection -->
                <div class="mb-4">
                    {{ form.course.label(class="form-label fw-bold") }}
                    {% if form.course.errors %}
                        {{ form.course(class="form-control form-control-lg is-invalid") }}
                        <div class="invalid-feedback">
                            {% for error in form.course.errors %}
                                <span>{{ error }}</span>
                                {% if existing_review_id and "already reviewed" in error %}
                                    <div class="mt-2">
                                        <a href="{{ url_for('posts.update_post', post_id=existing_review_id) }}" 
                                           class="btn btn-sm btn-danger">
                                            Edit Existing Review
                                        </a>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% else %}
                        {{ form.course(class="form-select form-select-lg") }}
                    {% endif %}
                </div>

                <hr class="my-4" style="border-color: var(--twilight-indigo); opacity: 0.2;">

                {% from 'macros.html' import render_rating_input %}

                <!-- Ratings Section -->
                <div class="row g-3">
                    <!-- Professor Rating -->
                    {{ render_rating_input(form.rating_professor, form.rating_professor.label.text, "1 = Not great, 5 = Amazing professor") }}

                    <!-- Material Rating -->
                    {{ render_rating_input(form.rating_material, form.rating_material.label.text, "1 = Boring course, 5 = Very interesting") }}

                    <!-- Workload Rating -->
                    {{ render_rating_input(form.rating_workload, form.rating_workload.label.text, "How demanding is this course?", is_workload=True) }}

                    <!-- Peers Rating -->
                    {{ render_rating_input(form.rating_peers, form.rating_peers.label.text, "1 = Not my usual crowd, 5 = Great classmates") }}
                </div>

                <!-- Overall Rating (computed, not selectable) -->
                <div class="mb-4">
                    <div class="form-label fw-bold mt-3">
                        Overall Rating
                        <i class="fas fa-info-circle info-tooltip" data-bs-toggle="tooltip" title="Automatically calculated from Professor, Material, and Peers ratings"></i>
                    </div>
                    <div class="rating-group" id="overall-rating-display">
                        <!-- This will be populated by JavaScript -->
                        <div class="text-muted small">Select Professor, Material, and Peers ratings to see your overall rating</div>
                    </div>
                </div>

                <hr class="my-4" style="border-color: var(--twilight-indigo); opacity: 0.2;">

                <!-- Tags Section -->
                <div class="mb-4">
                    <label class="form-label fw-bold mb-2">
                        Select up to 3 tags
                        <i class="fas fa-info-circle info-tooltip" data-bs-toggle="tooltip" title="Choose tags that best describe your experience"></i>
                    </label>
                    <div class="tags-container d-flex flex-wrap gap-2">
                        {% for tag in form.get_tags_with_sentiment() %}
                            <div class="tag-check-wrapper">
                                <input type="checkbox" 
                                       name="tags" 
                                       value="{{ tag.id }}" 
                                       id="tag-{{ tag.id }}" 
                                       class="tag-checkbox"
                                       {% if tag.id in (form.tags.data or []) %}checked{% endif %}>
                                <label for="tag-{{ tag.id }}" 
                                       class="tag-chip tag-{{ tag.sentiment.value }}">
                                    {{ tag.name }}
                                </label>
                            </div>
                        {% endfor %}
                    </div>
                    {% if form.tags.errors %}
                        <div class="text-danger-custom mt-2">
                            {% for e in form.tags.errors %}{{ e }}{% endfor %}
                        </div>
                    {% endif %}
                    <div class="text-muted small mt-2" id="tag-count-message"></div>
                </div>

                <hr class="my-4" style="border-color: var(--twilight-indigo); opacity: 0.2;">

                <!-- Content/Comment Section -->
                <div class="mb-4">
                    {{ form.content.label(class="form-label fw-bold") }}
                    {{ form.content(class="form-control mt-2", rows="6", placeholder="share what you liked, what was challenging, gossip about the professor, or advice for future students. be as serious, unserious or detailed as you wish :)") }}
                    {% if form.content.errors %}
                        <div class="invalid-feedback">
                            {% for e in form.content.errors %}{{ e }}{% endfor %}
                        </div>
                    {% endif %}
                </div>

                <!-- Title Section -->
                <div class="mb-4">
                    <label class="form-label fw-bold mb-0">{{ form.title.label.text }}</label>
                    {% if form.title.errors %}
                        {{ form.title(class="form-control form-control-lg is-invalid") }}
                        <div class="invalid-feedback">
                            {% for error in form.title.errors %}
                                <span>{{ error }}</span>
                            {% endfor %}
                        </div>
                    {% else %}
                        {{ form.title(class="form-control form-control-lg", placeholder="displayed in the feed!") }}
                    {% endif %}
                </div>

                <!-- Year Taken Section -->
                <div class="mb-4">
                    {{ form.year_taken.label(class="form-label fw-bold") }}
                    {% if form.year_taken.errors %}
                        {{ form.year_taken(class="form-control is-invalid", style="max-width: 150px;") }}
                        <div class="invalid-feedback">
                            {% for e in form.year_taken.errors %}{{ e }}{% endfor %}
                        </div>
                    {% else %}
                        {{ form.year_taken(class="form-control", style="max-width: 150px;") }}
                    {% endif %}
                </div>

            </fieldset>

            <div>
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    <span class="spinner-border spinner-border-sm d-none me-2" id="submitSpinner" role="status" aria-hidden="true"></span>
                    <span id="submitText">
                        {% if legend.startswith('Update') %}
                            Update Review
                        {% else %}
                            Create Review
                        {% endif %}
                    </span>
                </button>
            </div>
        </form>
    </div>
{% endblock content %}

{% block scripts %}
<script>
    // Initialize Bootstrap tooltips
    document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
        new bootstrap.Tooltip(el);
    });

    // Handle form submission loading state
    document.querySelector('form').addEventListener('submit', function(e) {
        const submitBtn = document.getElementById('submitBtn');
        const submitSpinner = document.getElementById('submitSpinner');
        const submitText = document.getElementById('submitText');

        // Disable button and show loading state
        submitBtn.disabled = true;
        submitSpinner.classList.remove('d-none');
        submitText.textContent = 'Submitting...';

        // Re-enable after a short delay if validation fails (form doesn't actually submit)
        // This handles client-side validation failures
        setTimeout(() => {
            if (!e.target.checkValidity() || e.defaultPrevented) {
                submitBtn.disabled = false;
                submitSpinner.classList.add('d-none');
                submitText.textContent = submitText.textContent.replace('Submitting...', submitBtn.dataset.originalText || 'Create Review');
            }
        }, 100);
    });

    // Store original button text for validation failure recovery
    document.addEventListener('DOMContentLoaded', function() {
        const submitText = document.getElementById('submitText');
        submitText.dataset.originalText = submitText.textContent.trim();
    });

    // Function to calculate and display overall rating (excludes workload)
    function updateOverallRating() {
        const prof = document.querySelector('input[name="rating_professor"]:checked');
        const material = document.querySelector('input[name="rating_material"]:checked');
        const peers = document.querySelector('input[name="rating_peers"]:checked');

        const overallDisplay = document.getElementById('overall-rating-display');

        if (prof && material && peers) {
            const profVal = parseInt(prof.value);
            const materialVal = parseInt(material.value);
            const peersVal = parseInt(peers.value);

            const overall = Math.round((profVal + materialVal + peersVal) / 3);

            overallDisplay.innerHTML = `
                <div class="text-center d-inline-block px-4 py-2">
                    <div class="rating-bar static">
                        ${Array(5).fill(0).map((_, i) => 
                            i < overall ? '<i class="fas fa-star active"></i>' : '<i class="fas fa-star"></i>'
                        ).join('')}
                    </div>
                    <div class="small fw-bold mt-1 text-muted">${overall}/5</div>
                </div>
            `;
        } else {
            overallDisplay.innerHTML = '<div class="text-muted small">Select Professor, Material, and Peers ratings to see your overall rating</div>';
        }
    }

    // Add event listeners to numeric rating inputs (excludes workload)
    document.querySelectorAll('input[name="rating_professor"], input[name="rating_material"], input[name="rating_peers"]').forEach(input => {
        input.addEventListener('change', updateOverallRating);
    });

    // Initial check in case form is pre-populated (for editing)
    document.addEventListener('DOMContentLoaded', updateOverallRating);

    // Tag selection limit (max 3 tags)
    const MAX_TAGS = 3;
    const tagCheckboxes = document.querySelectorAll('.tag-checkbox');
    const tagCountMessage = document.getElementById('tag-count-message');

    function updateTagCount() {
        const checked = document.querySelectorAll('.tag-checkbox:checked');
        const count = checked.length;
        
        if (count === 0) {
            tagCountMessage.textContent = '';
        } else if (count === MAX_TAGS) {
            tagCountMessage.textContent = `Maximum ${MAX_TAGS} tags selected`;
            tagCountMessage.classList.remove('text-muted');
            tagCountMessage.classList.add('text-theme-primary');
        } else {
            tagCountMessage.textContent = `${count} of ${MAX_TAGS} tags selected`;
            tagCountMessage.classList.remove('text-theme-primary');
            tagCountMessage.classList.add('text-muted');
        }
    }

    tagCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const checked = document.querySelectorAll('.tag-checkbox:checked');
            if (checked.length > MAX_TAGS) {
                this.checked = false;
                updateTagCount();
                return;
            }
            updateTagCount();
        });
    });

    // Initial tag count update
    document.addEventListener('DOMContentLoaded', updateTagCount);
</script>
{% endblock scripts %}
